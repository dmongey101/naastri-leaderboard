<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Responsive meta tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* Base styles */
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px;
      text-align: center;
    }
     /* Header style for the top-left logo */
     .header {
      
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 10px;
    }
    .header img {
      width: 80px; /* Adjust as needed */
      margin-right: 20px;
    }
    .header h1 {
      font-size: 1.5em;
      margin: 0;
    }
    h1, h2 {
      margin: 10px 0;
      font-size: 1.5em;
    }
    table {
      margin: 10px auto;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      font-size: 0.9em;
      text-align: center;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }
    .tab {
      flex: 1 1 auto;
      max-width: 150px;
      padding: 10px 15px;
      margin: 5px;
      background: #ddd;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .tab.active {
      background: #bbb;
      font-weight: bold;
    }
    footer img {
      width: 150px;
      max-width: 80%;
      margin-top: 20px;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 600px) {
      h1, h2 {
        font-size: 1.2em;
      }
      th, td {
        font-size: 0.8em;
        padding: 6px;
      }
      .tab {
        font-size: 0.8em;
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="content">
    <div class="header">
      <img src="/images/naas_tri.jpeg" alt="Naas Tri Logo">
    </div>
    <!-- Personal Weekly Totals Section -->
    <div id="personal-section">
      <h1>Your Weekly Totals</h1>
      <table id="weekly-totals-table">
        <thead>
          <tr>
            <th>Week</th>
            <th>Swim</th>
            <th>Bike</th>
            <th>Run</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="weekly-totals-body">
          <!-- Personal weekly totals will be inserted here -->
        </tbody>
      </table>
    </div>

    <!-- Team Leaderboard Section (Always shown) -->
    <h1>Team Leaderboard</h1>
    <div class="tabs">
      <div class="tab" data-week="Week 1 (10-16 March 2025)">Week 1</div>
      <div class="tab" data-week="Week 2 (17-23 March 2025)">Week 2</div>
      <div class="tab" data-week="Week 3 (24-30 March 2025)">Week 3</div>
      <div class="tab" data-week="Week 4 (31 March - 6 April 2025)">Week 4</div>
      <div class="tab" data-week="">Total</div>
    </div>
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>Team</th>
          <th>Swim</th>
          <th>Bike</th>
          <th>Run</th>
          <th>Total</th>
          <th>Left to Connect</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body">
        <!-- Team leaderboard rows will be inserted dynamically -->
      </tbody>
    </table>

    <footer>
      <img src="/images/powered-by-strava.png" alt="Powered by Strava">
    </footer>
  </div>

  <script>
    // Function to load personal weekly totals.
    function loadPersonalTotals() {
      fetch('/api/weekly-totals')
        .then(response => {
          if (response.status === 401) {
            throw new Error('Unauthorized');
          }
          return response.json();
        })
        .then(data => {
          const tbody = document.getElementById('weekly-totals-body');
          tbody.innerHTML = '';
          if (data.message) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5">${data.message}</td>`;
            tbody.appendChild(tr);
          } else {
            data.forEach(week => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${week.week}</td>
                <td>${parseFloat(week.swim).toFixed(2)}</td>
                <td>${parseFloat(week.bike).toFixed(2)}</td>
                <td>${parseFloat(week.run).toFixed(2)}</td>
                <td>${parseFloat(week.total).toFixed(2)}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(error => {
          if (error.message === 'Unauthorized') {
            // Replace the personal section with a Connect with Strava button.
            document.getElementById('personal-section').innerHTML = `
              <h2>Please sign in to see your weekly totals</h2>
              <a href="/auth/strava">
                <img src="/images/connect-with-strava.png" alt="Connect with Strava" style="width:200px;">
              </a>
            `;
          } else {
            console.error('Error fetching personal weekly totals:', error);
          }
        });
    }

    // Function to load the team leaderboard for a given week.
    function loadLeaderboard(week) {
      let url = '/api/leaderboard';
      if (week) {
        url += '?week=' + encodeURIComponent(week);
      }
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('leaderboard-body');
          tbody.innerHTML = '';
          data.leaderboard.forEach(team => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${team.team}</td>
              <td>${team.swim}</td>
              <td>${team.bike}</td>
              <td>${team.run}</td>
              <td>${team.total}</td>
              <td>${team.left_to_connect}</td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(error => console.error('Error fetching team leaderboard:', error));
    }

    // Tab click event handling.
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs.
        tabs.forEach(t => t.classList.remove('active'));
        // Set active class on clicked tab.
        this.classList.add('active');
        const week = this.getAttribute('data-week');
        loadLeaderboard(week);
      });
    });

    // Initialize: load personal totals and default team leaderboard ("Total").
    loadPersonalTotals();
    document.querySelector('.tab[data-week=""]').click();
  </script>
</body>
</html>
